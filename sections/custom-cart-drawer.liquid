

<div id="modern-cart-drawer" class="drawer-backdrop" aria-hidden="true">
  <div class="drawer-container">
    
    <!-- HEADER -->
    <div class="drawer-header">
      <h2 class="drawer-title">Your Cart <span id="drawer-count-bubble" class="count-bubble hidden">0</span></h2>
      <button class="drawer-close" aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- BODY (Scrollable) -->
    <div class="drawer-body" id="drawer-body">
      
      <!-- 1. Cart Items Area -->
      <div id="cart-items-container" class="cart-items-container">
        <!-- Injected via JS -->
        <div class="drawer-spinner-wrapper"><div class="spinner"></div></div>
      </div>

      <!-- 2. Upsell/Cross-sell Section -->
      <div id="drawer-upsell-container" class="drawer-upsell-section hidden">
        <h3 class="upsell-heading" id="upsell-heading">You may also like</h3>
        <div class="upsell-grid" id="upsell-grid">
          <!-- Injected via JS -->
        </div>
      </div>

    </div>

    <!-- FOOTER (Fixed at bottom) -->
    <div class="drawer-footer" id="drawer-footer">
      <div class="footer-row subtotal-row">
        <span>Subtotal</span>
        <span id="drawer-subtotal" class="price-text">$0.00</span>
      </div>
      <p class="footer-note">Shipping & taxes calculated at checkout.</p>
      <form action="/cart" method="post">
        <button type="submit" name="checkout" class="checkout-btn">
          Checkout
        </button>
      </form>
    </div>

  </div>
</div>

<!-- DATA: Fallback Collection (For Empty State) -->
{% if section.settings.empty_collection != blank %}
  <script type="application/json" id="fallback-products-data">
    [
      {% for product in section.settings.empty_collection.products limit: 4 %}
        {
          "id": {{ product.id }},
          "variant_id": {{ product.selected_or_first_available_variant.id }},
          "title": {{ product.title | json }},
          "price": {{ product.price | json }},
          "compare_at_price": {{ product.compare_at_price | json }},
          "image": "{{ product.featured_image | image_url: width: 400 }}",
          "available": {{ product.available }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>
{% endif %}

{% schema %}
{
  "name": "Modern Cart Drawer",
  "settings": [
    {
      "type": "header",
      "content": "Upsell / Cross-sell"
    },
    {
      "type": "paragraph",
      "content": "If cart is EMPTY, items from the collection below will show. If cart has ITEMS, Shopify's 'Frequently Bought Together' AI recommendations will show."
    },
    {
      "type": "collection",
      "id": "empty_collection",
      "label": "Fallback Collection (Empty Cart)"
    }
  ],
  "presets": [
    {
      "name": "Modern Cart Drawer"
    }
  ]
}
{% endschema %}

<style>
  /* --- VARIABLES & RESET --- */
  :root {
    --drawer-width: 420px;
    --drawer-bg: #ffffff;
    --drawer-text: #121212;
    --drawer-border: #e5e5e5;
    --drawer-btn-bg: #121212;
    --drawer-btn-text: #ffffff;
  }

  .drawer-backdrop {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.4);
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
    backdrop-filter: blur(3px);
  }
  
  .drawer-container {
    position: absolute; top: 0; right: 0; bottom: 0;
    width: 100%; max-width: var(--drawer-width);
    background: var(--drawer-bg);
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); /* Smooth easing */
    display: flex; flex-direction: column;
    box-shadow: -5px 0 30px rgba(0,0,0,0.1);
  }

  .drawer-backdrop.is-open { opacity: 1; visibility: visible; }
  .drawer-backdrop.is-open .drawer-container { transform: translateX(0); }

  /* --- HEADER --- */
  .drawer-header {
    padding: 20px 30px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--drawer-border);
  }
  .drawer-title { font-size: 20px; font-weight: 500; margin: 0; display: flex; align-items: center; }
  .count-bubble {
    font-size: 12px; background: #f0f0f0; padding: 2px 8px; border-radius: 12px; 
    margin-left: 8px; color: #555;
  }
  .drawer-close { background: none; border: none; cursor: pointer; padding: 5px; transition: 0.2s; }
  .drawer-close:hover { opacity: 0.6; transform: scale(1.1); }

  /* --- BODY (Scrolls) --- */
  .drawer-body {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding-bottom: 20px;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Spinner */
  .drawer-spinner-wrapper { display: flex; justify-content: center; padding: 40px; }
  .spinner {
    width: 24px; height: 24px; border: 2px solid #f3f3f3; border-top: 2px solid #333; 
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- ITEMS LIST --- */
  .cart-items-container { padding: 24px 30px 10px; }
  
  .cart-item { 
    display: flex; gap: 15px; margin-bottom: 25px; 
    transition: opacity 0.2s; position: relative;
  }
  .cart-item.loading { opacity: 0.5; pointer-events: none; } /* Performance feedback */

  .cart-item__img {
    width: 80px; height: 100px; flex-shrink: 0; border-radius: 6px; overflow: hidden; background: #f4f4f4;
  }
  .cart-item__img img { width: 100%; height: 100%; object-fit: cover; }

  .cart-item__info { flex: 1; display: flex; flex-direction: column; }
  
  .cart-item__title { 
    font-size: 14px; font-weight: 600; margin: 0 0 4px; 
    color: var(--drawer-text); text-decoration: none; line-height: 1.4; 
  }
  .cart-item__price { font-size: 14px; color: #555; margin-bottom: 8px; }
  .cart-item__variant { font-size: 12px; color: #888; margin-bottom: 4px; }

  .cart-item__actions {
    display: flex; align-items: center; justify-content: space-between; margin-top: auto;
  }
  
  .qty-group {
    display: flex; align-items: center; background: #f7f7f7; border-radius: 4px;
  }
  .qty-btn {
    width: 28px; height: 28px; border: none; background: none; cursor: pointer; 
    display: flex; align-items: center; justify-content: center; color: #555;
  }
  .qty-input {
    width: 30px; text-align: center; border: none; background: none; font-size: 13px; pointer-events: none;
  }
  
  .remove-link {
    font-size: 12px; text-decoration: underline; color: #888; background: none; border: none; cursor: pointer;
  }
  .remove-link:hover { color: #d00; }

  /* --- UPSELL SECTION --- */
  .drawer-upsell-section {
    margin-top: 10px; padding: 20px 30px; background: #fcfcfc; border-top: 1px solid #f0f0f0;
  }
  .upsell-heading {
    font-size: 16px; font-weight: 600; margin: 0 0 15px; font-family: var(--font-heading-family);
  }
  .upsell-grid { display: flex; flex-direction: column; gap: 15px; }
  
  .upsell-card {
    display: flex; align-items: center; gap: 15px; background: #fff; padding: 10px; 
    border: 1px solid #eee; border-radius: 8px; transition: transform 0.2s;
  }
  .upsell-card:hover { border-color: #ccc; }
  
  .upsell-img {
    width: 60px; height: 60px; border-radius: 4px; overflow: hidden; background: #f4f4f4; flex-shrink: 0;
  }
  .upsell-img img { width: 100%; height: 100%; object-fit: cover; }
  
  .upsell-details { flex: 1; }
  .upsell-title { font-size: 13px; font-weight: 600; margin: 0 0 4px; }
  .upsell-price { font-size: 13px; color: #666; }
  
  .upsell-add-btn {
    background: #fff; border: 1px solid #000; color: #000; padding: 6px 12px; 
    border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; 
    white-space: nowrap; transition: all 0.2s; min-width: 70px;
  }
  .upsell-add-btn:hover { background: #000; color: #fff; }
  .upsell-add-btn.adding { opacity: 0.7; pointer-events: none; }

  /* --- FOOTER --- */
  .drawer-footer {
    padding: 24px 30px; border-top: 1px solid var(--drawer-border); background: #fff;
  }
  .footer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .price-text { font-size: 18px; font-weight: 600; }
  .footer-note { font-size: 12px; color: #888; margin: 0 0 15px; }
  
  .checkout-btn {
    width: 100%; padding: 16px; background: var(--drawer-btn-bg); color: var(--drawer-btn-text); 
    border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: opacity 0.2s;
  }
  .checkout-btn:hover { opacity: 0.9; }

  /* Empty State specific */
  .cart-empty-msg { text-align: center; margin: 40px 0; color: #666; }
  .hidden { display: none !important; }

</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const drawer = document.getElementById('modern-cart-drawer');
    const closeBtn = drawer.querySelector('.drawer-close');
    const itemsContainer = document.getElementById('cart-items-container');
    const upsellContainer = document.getElementById('drawer-upsell-container');
    const upsellGrid = document.getElementById('upsell-grid');
    const upsellHeading = document.getElementById('upsell-heading');
    const footer = document.getElementById('drawer-footer');
    const subtotalEl = document.getElementById('drawer-subtotal');
    const countBubble = document.getElementById('drawer-count-bubble');
    
    // --- Helpers ---
    const formatMoney = (cents) => '$' + (cents / 100).toFixed(2);

    // --- Main Logic ---
    
    const openDrawer = () => {
      drawer.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
      sessionStorage.setItem('cartDrawerOpen', 'true');
      fetchCart(); // Refresh data
    };

    const closeDrawer = () => {
      drawer.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
      sessionStorage.setItem('cartDrawerOpen', 'false');
    };

    // 1. Fetch Cart Data
    const fetchCart = async () => {
      try {
        const res = await fetch('/cart.js');
        const cart = await res.json();
        renderDrawer(cart);
        
        // After rendering cart, decide which upsells to fetch
        if(cart.item_count > 0) {
           // Use Shopify Recommendations API based on first item
           fetchDynamicRecommendations(cart.items[0].product_id);
           upsellHeading.textContent = "Frequently bought together";
        } else {
           // Use Fallback Data
           renderFallbackUpsells();
           upsellHeading.textContent = "Bestsellers";
        }
        
      } catch (err) { console.error(err); }
    };

    // 2. Render Main Cart
    const renderDrawer = (cart) => {
      // Update Header/Footer Stats
      countBubble.textContent = cart.item_count;
      countBubble.classList.toggle('hidden', cart.item_count === 0);
      subtotalEl.textContent = formatMoney(cart.total_price);
      
      // Toggle Footer Visibility
      footer.style.display = cart.item_count === 0 ? 'none' : 'block';

      if (cart.item_count === 0) {
        itemsContainer.innerHTML = '<div class="cart-empty-msg">Your cart is empty.</div>';
      } else {
        let html = '';
        cart.items.forEach(item => {
          html += `
            <div class="cart-item" id="item-${item.key}">
              <div class="cart-item__img">
                <a href="${item.url}"><img src="${item.image}" alt="${item.title}" loading="lazy"></a>
              </div>
              <div class="cart-item__info">
                <a href="${item.url}" class="cart-item__title">${item.product_title}</a>
                ${item.variant_title ? `<div class="cart-item__variant">${item.variant_title}</div>` : ''}
                <div class="cart-item__price">${formatMoney(item.final_price)}</div>
                
                <div class="cart-item__actions">
                  <div class="qty-group">
                    <button class="qty-btn minus" data-key="${item.key}" data-qty="${item.quantity - 1}">âˆ’</button>
                    <input class="qty-input" type="number" value="${item.quantity}">
                    <button class="qty-btn plus" data-key="${item.key}" data-qty="${item.quantity + 1}">+</button>
                  </div>
                  <button class="remove-link" data-key="${item.key}">Remove</button>
                </div>
              </div>
            </div>
          `;
        });
        itemsContainer.innerHTML = html;
        attachItemListeners();
      }
    };

    // 3. Update Item (Optimized for Speed)
    const updateItem = async (key, qty, btnElement) => {
      // UI Feedback: Dim the row immediately
      const row = document.getElementById(`item-${key}`);
      if(row) row.classList.add('loading');

      try {
        const res = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({id: key, quantity: qty})
        });
        const cart = await res.json();
        renderDrawer(cart); // Re-render full state to be safe
      } catch (err) {
        console.error(err);
        if(row) row.classList.remove('loading'); // Remove loading on error
      }
    };

    // 4. Upsell Logic (API + Fallback)
    
    // A. Dynamic API Recommendations
    const fetchDynamicRecommendations = async (productId) => {
      try {
        const res = await fetch(`/recommendations/products.json?product_id=${productId}&limit=4`);
        const data = await res.json();
        if(data.products && data.products.length > 0) {
          renderUpsells(data.products);
        } else {
          renderFallbackUpsells(); // Fallback if API returns nothing
        }
      } catch (e) { renderFallbackUpsells(); }
    };

    // B. Fallback Recommendations (From Script Tag)
    const renderFallbackUpsells = () => {
      const scriptTag = document.getElementById('fallback-products-data');
      if (scriptTag) {
        const products = JSON.parse(scriptTag.textContent);
        renderUpsells(products);
      }
    };

    // C. Render Logic for Upsells
    const renderUpsells = (products) => {
      // 1. Filter out items already in cart
      // Note: We need current cart state. We can get it from global cart object or re-fetch.
      // For speed, we assume simple render first.
      
      let html = '';
      products.forEach(prod => {
        // Basic check for availability
        if(!prod.available) return; 
        
        // Normalize image URL if needed (API returns distinct structure vs Liquid)
        let img = prod.featured_image || prod.image; // Handle both API/Liquid formats
        // Fix Shopify Image URL protocol if missing
        if(img && !img.startsWith('http')) img = 'https:' + img;

        const variantId = prod.variants ? prod.variants[0].id : prod.variant_id; // Handle both formats

        html += `
          <div class="upsell-card">
            <div class="upsell-img"><img src="${img}" alt="${prod.title}"></div>
            <div class="upsell-details">
              <div class="upsell-title">${prod.title}</div>
              <div class="upsell-price">${formatMoney(prod.price)}</div>
            </div>
            <button class="upsell-add-btn" data-id="${variantId}">Add</button>
          </div>
        `;
      });
      
      if(html) {
        upsellGrid.innerHTML = html;
        upsellContainer.classList.remove('hidden');
        
        // Attach Upsell Listeners
        document.querySelectorAll('.upsell-add-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
             const id = btn.dataset.id;
             btn.textContent = 'Adding...';
             btn.classList.add('adding');
             await addItemToCart(id);
             btn.textContent = 'Add';
             btn.classList.remove('adding');
          });
        });
      } else {
        upsellContainer.classList.add('hidden');
      }
    };

    // 5. Add Upsell Item
    const addItemToCart = async (id) => {
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ items: [{ id: id, quantity: 1 }] })
      });
      fetchCart();
    };

    // --- Listeners ---
    const attachItemListeners = () => {
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          updateItem(btn.dataset.key, parseInt(btn.dataset.qty), btn);
        });
      });
      
      document.querySelectorAll('.remove-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          updateItem(btn.dataset.key, 0, btn);
        });
      });
    };

    // Close actions
    closeBtn.addEventListener('click', closeDrawer);
    drawer.addEventListener('click', (e) => {
      if (e.target === drawer) closeDrawer();
    });

    // Hijack Cart Icon
    document.querySelectorAll('a[href="/cart"]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        openDrawer();
      });
    });
    
    // Session Persistence
    if (sessionStorage.getItem('cartDrawerOpen') === 'true') {
      // openDrawer(); // Uncomment if you want auto-open on reload
    }
  });
</script>
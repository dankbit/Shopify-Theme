<div id="modern-cart-drawer" class="drawer-backdrop" aria-hidden="true">
  <div class="drawer-container">
    
    <!-- HEADER -->
    <div class="drawer-header">
      <h2 class="drawer-title">Your Cart <span id="drawer-count-bubble" class="count-bubble hidden">0</span></h2>
      <button class="drawer-close" aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- SHIPPING BAR -->
    {% assign threshold_cents = section.settings.free_shipping_threshold | times: 100 %}
    <div class="shipping-bar-container" data-threshold="{{ threshold_cents }}">
      <p class="shipping-text" id="shipping-text">
        You are <span id="shipping-remaining" style="font-weight:700;"></span> away from <strong>Free Shipping</strong>
      </p>
      <div class="shipping-track-wrapper">
        <div class="shipping-track">
          <div class="shipping-fill" id="shipping-fill" style="width: 0%; background-color: #d90429;"></div>
        </div>
        <div class="shipping-truck" id="shipping-truck" style="left: 0%;">
          <div class="truck-bubble" id="truck-bubble">0%</div>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
        </div>
      </div>
      <div class="shipping-success hidden" id="shipping-success">
        ðŸŽ‰ You've unlocked <strong>Free Shipping!</strong>
      </div>
    </div>

    <!-- BODY -->
    <div class="drawer-body" id="drawer-body">
      <div id="cart-items-container" class="cart-items-container">
        <div class="drawer-spinner-wrapper"><div class="spinner"></div></div>
      </div>

      <!-- Upsell -->
      <div id="drawer-upsell-container" class="drawer-upsell-section hidden">
        <h3 class="upsell-heading" id="upsell-heading">You may also like</h3>
        <div class="upsell-grid" id="upsell-grid"></div>
      </div>
    </div>

    <!-- UTILITIES -->
    <div class="drawer-utilities">
      <div class="utility-icons">
        <button class="util-btn" data-target="util-note" title="Order Note">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
        <button class="util-btn" data-target="util-discount" title="Discount">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
        </button>
        <button class="util-btn" data-target="util-date" title="Delivery Date">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        </button>
      </div>

      <!-- Note Section -->
      <div class="util-content hidden" id="util-note">
        <div class="util-header"><label>Order Note</label><span class="save-badge hidden" id="msg-note">âœ“ Saved</span></div>
        <textarea id="cart-note" placeholder="Special instructions...">{{ cart.note }}</textarea>
        <div class="util-actions">
          <button class="action-btn cancel" data-type="note">Cancel</button>
          <button class="action-btn save" data-type="note">Save</button>
        </div>
      </div>

      <!-- Discount Section -->
      <div class="util-content hidden" id="util-discount">
        <div class="util-header"><label>Discount Code</label><span class="save-badge hidden" id="msg-discount">âœ“ Saved</span></div>
        <input type="text" id="cart-discount" placeholder="Code applied at checkout">
        <div class="util-actions">
          <button class="action-btn cancel" data-type="discount">Cancel</button>
          <button class="action-btn save" data-type="discount">Save</button>
        </div>
      </div>

      <!-- Date Section -->
      <div class="util-content hidden" id="util-date">
        <div class="util-header"><label>Delivery Date</label><span class="save-badge hidden" id="msg-date">âœ“ Saved</span></div>
        <input type="date" id="cart-date" value="{{ cart.attributes['Delivery Date'] }}">
        <div class="util-actions">
          <button class="action-btn cancel" data-type="date">Cancel</button>
          <button class="action-btn save" data-type="date">Save</button>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="drawer-footer hidden" id="drawer-footer">
      <div class="footer-row subtotal-row">
        <span>Subtotal</span>
        <span id="drawer-subtotal" class="price-text">$0.00</span>
      </div>
      <p class="footer-note">Tax included. Shipping calculated at checkout.</p>
      <div class="footer-buttons">
        <a href="/cart" class="view-cart-btn">View Cart</a>
        <form action="/cart" method="post" id="drawer-checkout-form" class="checkout-form-wrapper">
          <button type="submit" name="checkout" class="checkout-btn">Checkout</button>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- DATA & SCHEMA -->
{% if section.settings.empty_collection != blank %}
  <script type="application/json" id="fallback-products-data">
    [
      {% for product in section.settings.empty_collection.products limit: 4 %}
        {
          "id": {{ product.id }},
          "variant_id": {{ product.selected_or_first_available_variant.id }},
          "title": {{ product.title | json }},
          "price": {{ product.price | json }},
          "image": "{{ product.featured_image | image_url: width: 400 }}",
          "available": {{ product.available }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>
{% endif %}

{% schema %}
{
  "name": "Modern Cart Drawer",
  "settings": [
    { "type": "number", "id": "free_shipping_threshold", "label": "Free Shipping Threshold", "default": 3000 },
    { "type": "collection", "id": "empty_collection", "label": "Upsell Collection (Required)" }
  ]
}
{% endschema %}

<style>
  /* VARIABLES */
  :root {
    --drawer-width: 420px;
    --bg: #ffffff; --text: #121212; --border: #e5e5e5;
    --bar-bg: #f0f0f0;
    --bar-fill: #d90429;
    --bar-truck: #333;
  }
  .hidden { display: none !important; }

  /* DRAWER STRUCTURE */
  .drawer-backdrop { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: opacity 0.3s ease; backdrop-filter: blur(3px); }
  .drawer-container { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; max-width: var(--drawer-width); background: var(--bg); transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
  .drawer-backdrop.is-open { opacity: 1; visibility: visible; }
  .drawer-backdrop.is-open .drawer-container { transform: translateX(0); }

  /* HEADER */
  .drawer-header { padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
  .drawer-title { font-size: 18px; font-weight: 700; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
  .count-bubble { font-size: 12px; background: #f4f4f4; padding: 2px 8px; border-radius: 12px; margin-left: 8px; }
  .drawer-close { background: none; border: none; cursor: pointer; padding: 5px; transition: transform 0.2s; }
  .drawer-close:hover { transform: rotate(90deg); }

  /* SHIPPING BAR */
  .shipping-bar-container { padding: 15px 25px; background: #fff; border-bottom: 1px solid var(--border); }
  .shipping-text { font-size: 13px; margin: 0 0 12px; text-align: center; color: #555; }
  .shipping-track-wrapper { position: relative; height: 32px; margin-bottom: 5px; margin-top: 12px; }
  .shipping-track { width: 100%; height: 6px; background: var(--bar-bg); border-radius: 4px; overflow: hidden; position: absolute; top: 16px; }
  .shipping-fill { height: 100%; background-color: #d90429 !important; width: 0%; transition: width 0.5s ease; }
  .shipping-truck { position: absolute; top: -2px; width: 40px; height: 40px; color: var(--bar-truck); transition: left 0.5s ease; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
  .truck-bubble { background: #000; color: #fff; font-size: 9px; font-weight: bold; padding: 2px 5px; border-radius: 8px; margin-bottom: 2px; white-space: nowrap; }
  .shipping-success { text-align: center; font-size: 13px; color: #27ae60; font-weight: 600; animation: slideUpFade 0.5s ease; }

  /* BODY */
  .drawer-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px 25px; }
  .spinner { width: 24px; height: 24px; border: 2px solid #eee; border-top: 2px solid #333; border-radius: 50%; animation: spin 0.8s infinite; margin: 0 auto; }
  
  /* CART ITEM */
  .cart-item { display: flex; gap: 15px; margin-bottom: 20px; position: relative; border-bottom: 1px solid #f9f9f9; padding-bottom: 20px; align-items: flex-start; }
  .cart-item.updating { opacity: 0.6; pointer-events: none; }
  .cart-item.removing { transform: translateX(100%); opacity: 0; max-height: 0; margin: 0; padding: 0; overflow: hidden; transition: all 0.3s ease; }
  .cart-item__img { width: 80px; height: 100px; border-radius: 4px; overflow: hidden; flex-shrink: 0; background: #f9f9f9; }
  .cart-item__img img { width: 100%; height: 100%; object-fit: cover; }
  .cart-item__content { flex: 1; display: flex; justify-content: space-between; }
  .cart-item__stack { display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
  .cart-item__title { font-size: 13px; font-weight: 700; margin: 0; text-decoration: none; color: #000; text-transform: uppercase; line-height: 1.3; }
  .cart-item__price { font-size: 13px; color: #333; font-weight: 600; margin-bottom: 2px; }
  .cart-item__variant { font-size: 11px; color: #666; }
  .qty-group { display: flex; border: 1px solid #ddd; border-radius: 4px; width: 80px; height: 28px; margin-top: 6px; }
  .qty-btn { width: 26px; height: 100%; border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .qty-input { width: 28px; text-align: center; border: none; background: none; font-size: 12px; padding: 0; pointer-events: none; }
  .cart-item__remove { margin-top: auto; margin-bottom: 5px; display: flex; align-items: flex-end; }
  .remove-link { font-size: 12px; color: #666; text-decoration: underline; background: none; border: none; cursor: pointer; white-space: nowrap; margin-left: 10px; align-self: flex-end; }

  /* UPSELLS */
  .drawer-upsell-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
  .upsell-heading { font-size: 14px; font-weight: 600; margin-bottom: 15px; }
  .upsell-card { display: flex; gap: 15px; align-items: center; background: #fff; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; justify-content: space-between; }
  .upsell-img { width: 50px; height: 50px; border-radius: 4px; flex-shrink: 0; overflow: hidden; }
  .upsell-img img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .upsell-details { flex: 1; padding-right: 10px; }
  .upsell-title { font-size: 13px; font-weight: 600; margin: 0; line-height: 1.2; }
  .upsell-price { font-size: 12px; color: #555; margin-top: 2px; }
  .upsell-add-btn { background: #000; color: #fff; border: none; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; cursor: pointer; flex-shrink: 0; }

  /* UTILITIES */
  .drawer-utilities { background: #fcfcfc; border-top: 1px solid var(--border); padding: 10px 25px; }
  .utility-icons { display: flex; justify-content: space-around; margin-bottom: 5px; }
  .util-btn { width: 40px; height: 40px; border: 1px solid #eee; background: #fff; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .util-btn.active { background: #333; color: #fff; }
  
  .util-content { margin-top: 10px; padding: 15px; border: 1px solid #eee; background: #fff; border-radius: 6px; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
  .util-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .util-header label { font-weight: 600; font-size: 13px; color: #555; }
  .util-content input, .util-content textarea { width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: inherit; resize: vertical; }
  .util-content textarea { min-height: 60px; }

  .util-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
  .action-btn { padding: 6px 14px; font-size: 11px; border-radius: 4px; font-weight: 600; cursor: pointer; border: none; text-transform: uppercase; letter-spacing: 0.5px; }
  .action-btn.save { background-color: #27ae60; color: white; }
  .action-btn.save:hover { background-color: #219150; }
  .action-btn.cancel { background-color: #e5e5e5; color: #555; }
  .action-btn.cancel:hover { background-color: #d4d4d4; }
  
  .save-badge { font-size: 11px; color: #27ae60; font-weight: 700; animation: fadeIn 0.3s ease; }

  /* FOOTER */
  .drawer-footer { padding: 20px 25px; background: #fff; border-top: 1px solid var(--border); }
  .footer-row { display: flex; justify-content: space-between; font-weight: 700; font-size: 16px; margin-bottom: 5px; }
  .footer-buttons { display: flex; gap: 12px; height: 48px; width: 100%; }
  .view-cart-btn, .checkout-form-wrapper { flex: 1; height: 100%; width: 50%; }
  .view-cart-btn { display: flex; align-items: center; justify-content: center; text-align: center; text-decoration: none; font-weight: 700; font-size: 13px; text-transform: uppercase; border-radius: 4px; cursor: pointer; padding: 0; background: #333; color: #fff; box-sizing: border-box; }
  .checkout-btn { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; font-weight: 700; font-size: 13px; text-transform: uppercase; border-radius: 4px; cursor: pointer; padding: 0; background: #4834d4; color: #fff; border: none; box-sizing: border-box; }

  @keyframes slideUpFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- DOM ELEMENTS ---
    const drawer = document.getElementById('modern-cart-drawer');
    const itemsContainer = document.getElementById('cart-items-container');
    const subtotalEl = document.getElementById('drawer-subtotal');
    const countBubble = document.getElementById('drawer-count-bubble');
    const footer = document.getElementById('drawer-footer');
    
    // Utilities Elements
    const noteInput = document.getElementById('cart-note');
    const dateInput = document.getElementById('cart-date');
    const discountInput = document.getElementById('cart-discount');

    // --- SHIPPING LOGIC ---
    const shippingBar = document.querySelector('.shipping-bar-container');
    const thresholdCents = parseFloat(shippingBar.dataset.threshold);
    const formatMoney = (cents) => 'Rs. ' + (cents / 100).toFixed(2);

    // --- STATE MANAGEMENT (Session Storage) ---
    // 1. Initialize Inputs from Storage (Draft)
    if(sessionStorage.getItem('draft_note')) noteInput.value = sessionStorage.getItem('draft_note');
    if(sessionStorage.getItem('draft_date')) dateInput.value = sessionStorage.getItem('draft_date');
    if(sessionStorage.getItem('draft_discount')) discountInput.value = sessionStorage.getItem('draft_discount');

    // 2. Listeners for "Drafting" (Save as you type)
    noteInput.addEventListener('input', (e) => sessionStorage.setItem('draft_note', e.target.value));
    dateInput.addEventListener('input', (e) => sessionStorage.setItem('draft_date', e.target.value));
    discountInput.addEventListener('input', (e) => sessionStorage.setItem('draft_discount', e.target.value));

    // --- DRAWER ACTIONS ---
    const openDrawer = () => { 
      drawer.classList.add('is-open'); 
      drawer.setAttribute('aria-hidden', 'false'); 
      sessionStorage.setItem('cart_drawer_open', 'true'); 
      getCartData(); 
    };
    const closeDrawer = () => { 
      drawer.classList.remove('is-open'); 
      drawer.setAttribute('aria-hidden', 'true'); 
      sessionStorage.setItem('cart_drawer_open', 'false'); 
    };

    // --- UTILITY BUTTON ACTIONS (Save / Cancel) ---
    document.querySelectorAll('.action-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const type = btn.dataset.type;
        const isSave = btn.classList.contains('save');
        const container = document.getElementById(`util-${type}`);
        const msgElement = document.getElementById(`msg-${type}`);

        if (isSave) {
          // SAVE LOGIC
          if(type === 'note') await updateCartAttribute('note', noteInput.value);
          if(type === 'date') await updateCartAttribute('attributes', { 'Delivery Date': dateInput.value });
          if(type === 'discount') sessionStorage.setItem('saved_discount', discountInput.value);
          
          // Show "Saved" badge
          msgElement.classList.remove('hidden');
          setTimeout(() => msgElement.classList.add('hidden'), 2000);

        } else {
          // CANCEL LOGIC
          // 1. Remove draft from storage
          sessionStorage.removeItem(`draft_${type}`);
          
          // 2. FORCE CLEAR INPUT 
          if(type === 'note') noteInput.value = '';
          if(type === 'date') dateInput.value = '';
          if(type === 'discount') discountInput.value = '';

          // 3. Close view
          container.classList.add('hidden');
          document.querySelector(`.util-btn[data-target="util-${type}"]`).classList.remove('active');
        }
      });
    });

    const updateCartAttribute = async (key, value) => {
      try {
        await fetch('/cart/update.js', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ [key]: value })
        });
      } catch(e) { console.error(e); }
    };

    // --- CORE CART FUNCTIONS (Standard) ---
    const getCartData = async () => {
      try {
        const res = await fetch('/cart.js');
        const cart = await res.json();
        renderDrawer(cart);
        updateShippingBar(cart.total_price);
        determineUpsells(cart);
      } catch (err) { console.error(err); }
    };

    const postCartChange = async (url, body, rowElement = null) => {
      try {
        await fetch(url, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ ...body, sections: 'cart-icon-bubble' })
        });
        await getCartData();
        if(rowElement) rowElement.classList.remove('updating');
      } catch (err) { console.error(err); }
    };

    const renderDrawer = (cart) => {
      countBubble.textContent = cart.item_count;
      countBubble.classList.toggle('hidden', cart.item_count === 0);
      subtotalEl.textContent = formatMoney(cart.total_price);

      if (cart.item_count === 0) {
        itemsContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">Your cart is empty</div>';
        footer.classList.add('hidden');
      } else {
        footer.classList.remove('hidden');
        let html = '';
        cart.items.forEach(item => {
          html += `
            <div class="cart-item" id="item-${item.key}">
              <div class="cart-item__img"><img src="${item.image}" alt="${item.title}"></div>
              <div class="cart-item__content">
                <div class="cart-item__stack">
                  <a href="${item.url}" class="cart-item__title">${item.product_title}</a>
                  <div class="cart-item__price">${formatMoney(item.final_price)}</div>
                  ${item.variant_title ? `<div class="cart-item__variant">${item.variant_title}</div>` : ''}
                  <div class="qty-group">
                    <button class="qty-btn minus" data-key="${item.key}" data-qty="${item.quantity - 1}">-</button>
                    <input class="qty-input" type="text" value="${item.quantity}" readonly>
                    <button class="qty-btn plus" data-key="${item.key}" data-qty="${item.quantity + 1}">+</button>
                  </div>
                </div>
                <div class="cart-item__remove">
                  <button class="remove-link" data-key="${item.key}">Remove</button>
                </div>
              </div>
            </div>
          `;
        });
        itemsContainer.innerHTML = html;
        attachListeners();
      }
    };

    const updateShippingBar = (totalCents) => {
      if(thresholdCents <= 0) return;
      let percent = (totalCents / thresholdCents) * 100;
      if (percent > 100) percent = 100;
      const fill = document.getElementById('shipping-fill');
      const truck = document.getElementById('shipping-truck');
      const success = document.getElementById('shipping-success');
      const txt = document.getElementById('shipping-text');
      
      fill.style.width = `${percent}%`;
      truck.style.left = `${percent}%`;
      document.getElementById('truck-bubble').textContent = `${Math.round(percent)}%`;

      if (totalCents >= thresholdCents) {
        txt.classList.add('hidden');
        success.classList.remove('hidden');
        fill.style.backgroundColor = '#27ae60';
        truck.style.color = '#27ae60';
      } else {
        const remaining = thresholdCents - totalCents;
        document.getElementById('shipping-remaining').textContent = formatMoney(remaining);
        txt.classList.remove('hidden');
        success.classList.add('hidden');
        fill.style.backgroundColor = '#d90429';
        truck.style.color = '#333';
      }
    };

    const determineUpsells = (cart) => {
      const container = document.getElementById('drawer-upsell-container');
      const grid = document.getElementById('upsell-grid');
      if(!container) return;
      
      if(cart.item_count > 0) {
        fetch(`/recommendations/products.json?product_id=${cart.items[0].product_id}&limit=2`)
          .then(res => res.json())
          .then(data => { 
             if(data.products && data.products.length > 0) {
               renderUpsells(data.products, grid, container);
               document.getElementById('upsell-heading').textContent = "Frequently Bought Together";
             } else { runFallback(grid, container); }
          }).catch(() => runFallback(grid, container));
      } else { runFallback(grid, container); }
    };

    const runFallback = (grid, container) => {
      const script = document.getElementById('fallback-products-data');
      if(script) {
         renderUpsells(JSON.parse(script.textContent), grid, container);
         document.getElementById('upsell-heading').textContent = "You may also like"; 
      }
    };

    const renderUpsells = (products, grid, container) => {
      let html = '';
      products.forEach(prod => {
        if(!prod.available) return;
        let img = prod.featured_image || prod.image;
        if(img && !img.startsWith('http')) img = 'https:' + img;
        const varId = prod.variants ? prod.variants[0].id : prod.variant_id;
        html += `<div class="upsell-card"><div class="upsell-img"><img src="${img}"></div><div class="upsell-details"><div class="upsell-title">${prod.title}</div><div class="upsell-price">${formatMoney(prod.price)}</div></div><button class="upsell-add-btn" onclick="addUpsell(${varId}, this)">Add</button></div>`;
      });
      if(html) { grid.innerHTML = html; container.classList.remove('hidden'); }
    };

    window.addUpsell = (id, btn) => { btn.classList.add('adding'); btn.textContent = '...'; postCartChange('/cart/add.js', { items: [{ id: id, quantity: 1 }] }); };

    const attachListeners = () => {
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); const row = btn.closest('.cart-item'); row.classList.add('updating'); postCartChange('/cart/change.js', { id: btn.dataset.key, quantity: parseInt(btn.dataset.qty) }, row); });
      });
      document.querySelectorAll('.remove-link').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); const row = btn.closest('.cart-item'); row.classList.add('removing'); setTimeout(() => postCartChange('/cart/change.js', { id: btn.dataset.key, quantity: 0 }), 300); });
      });
    };

    document.querySelectorAll('.util-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.dataset.target);
        const isHidden = target.classList.contains('hidden');
        document.querySelectorAll('.util-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.util-btn').forEach(b => b.classList.remove('active'));
        if(isHidden) { target.classList.remove('hidden'); btn.classList.add('active'); }
      });
    });

    document.getElementById('drawer-checkout-form')?.addEventListener('submit', (e) => { 
      const code = discountInput.value.trim() || sessionStorage.getItem('saved_discount');
      if(code) { e.preventDefault(); window.location.href = `/checkout?discount=${code}`; } 
    });

    document.querySelector('.drawer-close').addEventListener('click', closeDrawer);
    document.querySelector('.drawer-backdrop').addEventListener('click', (e) => { if(e.target.classList.contains('drawer-backdrop')) closeDrawer(); });
    document.querySelectorAll('a[href="/cart"]:not(.view-cart-btn)').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); openDrawer(); }); });

    if (sessionStorage.getItem('cart_drawer_open') === 'true') openDrawer();
  });
</script>
```


<div id="modern-cart-drawer" class="drawer-backdrop" aria-hidden="true">
  <div class="drawer-container">
    
    <!-- HEADER -->
    <div class="drawer-header">
      <h2 class="drawer-title">Your Cart <span id="drawer-count-bubble" class="count-bubble hidden">0</span></h2>
      <button class="drawer-close" aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>

    <!-- BODY -->
    <div class="drawer-body" id="drawer-body">
      <!-- Content injected via JS (Loading State) -->
      <div class="drawer-loading">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="drawer-footer" id="drawer-footer">
      <div class="footer-row subtotal-row">
        <span>Subtotal</span>
        <span id="drawer-subtotal" class="price-text">$0.00</span>
      </div>
      <p class="footer-note">Shipping & taxes calculated at checkout.</p>
      <form action="/cart" method="post">
        <button type="submit" name="checkout" class="checkout-btn">
          Checkout
        </button>
      </form>
    </div>

  </div>
</div>

<!-- DATA BOOSTER: Pass Collection Data to JS -->
{% if section.settings.empty_collection != blank %}
  <script type="application/json" id="drawer-recommendations-data">
    [
      {% for product in section.settings.empty_collection.products limit: 4 %}
        {
          "id": {{ product.id }},
          "title": {{ product.title | json }},
          "price": {{ product.price | json }},
          "image": "{{ product.featured_image | image_url: width: 400 }}",
          "has_only_default_variant": {{ product.has_only_default_variant }},
          "variants": {{ product.variants | json }},
          "options": {{ product.options_with_values | json }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>
{% endif %}

{% schema %}
{
  "name": "Modern Cart Drawer",
  "settings": [
    {
      "type": "header",
      "content": "Empty State Recommendations"
    },
    {
      "type": "paragraph",
      "content": "Select a collection to show when the cart is empty."
    },
    {
      "type": "collection",
      "id": "empty_collection",
      "label": "Recommended Collection"
    }
  ],
  "presets": [
    {
      "name": "Modern Cart Drawer"
    }
  ]
}
{% endschema %}

<style>
  /* --- VARIABLES & RESET --- */
  :root {
    --drawer-width: 450px;
    --drawer-bg: #ffffff;
    --drawer-text: #121212;
    --drawer-accent: #121212; /* Black buttons */
    --drawer-border: #f0f0f0;
    --drawer-gray: #757575;
  }

  .drawer-backdrop {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(0,0,0,0.3);
    opacity: 0; visibility: hidden; transition: all 0.3s ease;
    backdrop-filter: blur(2px);
  }
  
  .drawer-container {
    position: absolute; top: 0; right: 0; bottom: 0;
    width: 100%; max-width: var(--drawer-width);
    background: var(--drawer-bg);
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; flex-direction: column;
    box-shadow: -5px 0 25px rgba(0,0,0,0.05);
  }

  /* OPEN STATE */
  .drawer-backdrop.is-open { opacity: 1; visibility: visible; }
  .drawer-backdrop.is-open .drawer-container { transform: translateX(0); }

  /* --- HEADER --- */
  .drawer-header {
    padding: 24px 32px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--drawer-border);
  }
  .drawer-title { font-size: 20px; font-weight: 500; margin: 0; letter-spacing: -0.02em; }
  .count-bubble {
    font-size: 12px; background: var(--drawer-border); padding: 2px 8px; 
    border-radius: 10px; margin-left: 8px; vertical-align: middle;
  }
  .drawer-close { background: none; border: none; cursor: pointer; padding: 5px; transition: opacity 0.2s; }
  .drawer-close:hover { opacity: 0.6; }

  /* --- BODY --- */
  .drawer-body {
    flex: 1; overflow-y: auto; padding: 0; position: relative;
  }
  
  /* Loading Spinner */
  .drawer-loading {
    position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; background: #fff; z-index: 10;
  }
  .spinner {
    width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #333; border-radius: 50%; animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* --- CART ITEMS LIST --- */
  .cart-items-list { padding: 24px 32px; }
  .cart-item { display: flex; gap: 20px; margin-bottom: 32px; }
  
  .cart-item__img {
    width: 90px; height: 110px; flex-shrink: 0; border-radius: 8px; overflow: hidden; background: #f9f9f9;
  }
  .cart-item__img img { width: 100%; height: 100%; object-fit: cover; }

  .cart-item__info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
  
  .cart-item__top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
  .cart-item__title { 
    font-size: 15px; font-weight: 500; margin: 0 0 4px; color: var(--drawer-text); text-decoration: none; line-height: 1.4; 
  }
  .cart-item__variant { font-size: 13px; color: var(--drawer-gray); margin-bottom: 6px; }
  .cart-item__price { font-weight: 500; font-size: 14px; }

  /* Quantity & Remove Row */
  .cart-item__actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
  
  .qty-selector {
    display: flex; align-items: center; background: #f7f7f7; border-radius: 6px; padding: 2px;
  }
  .qty-btn {
    width: 28px; height: 28px; border: none; background: none; cursor: pointer; 
    font-size: 16px; color: #555; display: flex; align-items: center; justify-content: center;
  }
  .qty-input {
    width: 30px; text-align: center; background: none; border: none; font-size: 13px; font-weight: 500; -moz-appearance: textfield;
  }
  .remove-btn {
    background: none; border: none; text-decoration: underline; font-size: 12px; color: var(--drawer-gray); cursor: pointer;
  }
  .remove-btn:hover { color: #e74c3c; }


  /* --- EMPTY STATE (RECOMMENDATIONS) --- */
  .empty-state-container { padding: 32px; }
  .empty-msg { text-align: center; margin-bottom: 40px; color: var(--drawer-gray); }
  .empty-title { font-size: 18px; font-weight: 500; color: var(--drawer-text); margin-bottom: 8px; }

  .rec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  
  .rec-card {
    display: flex; flex-direction: column; gap: 10px;
  }
  .rec-img {
    width: 100%; aspect-ratio: 1; border-radius: 8px; background: #f9f9f9; overflow: hidden; position: relative;
  }
  .rec-img img { width: 100%; height: 100%; object-fit: cover; transition: scale 0.3s; }
  .rec-card:hover .rec-img img { scale: 1.05; }

  .rec-details { text-align: left; }
  .rec-title { font-size: 14px; font-weight: 500; margin: 0 0 4px; }
  .rec-price { font-size: 13px; color: var(--drawer-gray); margin-bottom: 8px; }

  /* Variant Selector UI inside Card */
  .rec-actions { margin-top: 5px; }
  
  .rec-add-btn {
    width: 100%; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px;
    font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;
  }
  .rec-add-btn:hover { border-color: #000; }

  .rec-variants { margin-top: 8px; animation: fadeIn 0.3s ease; }
  .rec-select {
    width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; margin-bottom: 8px; background: #fff;
  }
  .rec-confirm-btn {
    width: 100%; padding: 10px; background: #000; color: #fff; border: none; border-radius: 6px;
    font-size: 13px; cursor: pointer;
  }

  /* --- FOOTER --- */
  .drawer-footer {
    padding: 24px 32px; border-top: 1px solid var(--drawer-border); background: #fff;
  }
  .footer-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px; }
  .subtotal-row span:first-child { font-size: 14px; color: var(--drawer-gray); }
  .price-text { font-size: 18px; font-weight: 600; }
  .footer-note { font-size: 12px; color: #999; margin-bottom: 20px; margin-top: 0; }
  
  .checkout-btn {
    width: 100%; padding: 16px; background: var(--drawer-accent); color: #fff; border: none;
    border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
  }
  .checkout-btn:hover { opacity: 0.9; }

  /* --- UTILS --- */
  .hidden { display: none !important; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const drawer = document.getElementById('modern-cart-drawer');
    const closeBtn = drawer.querySelector('.drawer-close');
    const drawerBody = document.getElementById('drawer-body');
    const drawerFooter = document.getElementById('drawer-footer');
    const subtotalEl = document.getElementById('drawer-subtotal');
    const countBubble = document.getElementById('drawer-count-bubble');
    
    // --- State ---
    let recommendations = [];
    try {
      const scriptTag = document.getElementById('drawer-recommendations-data');
      if (scriptTag) recommendations = JSON.parse(scriptTag.textContent);
    } catch (e) { console.error('JSON Parse Error', e); }

    // --- Helpers ---
    const formatMoney = (cents) => '$' + (cents / 100).toFixed(2);

    // --- Core Actions ---
    
    const openDrawer = () => {
      drawer.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
      fetchCart(); // Always refresh on open
    };

    const closeDrawer = () => {
      drawer.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
    };

    const fetchCart = async () => {
      toggleLoading(true);
      try {
        const res = await fetch('/cart.js');
        const cart = await res.json();
        renderDrawer(cart);
      } catch (err) { console.error(err); }
      finally { toggleLoading(false); }
    };

    const toggleLoading = (show) => {
      const loader = drawer.querySelector('.drawer-loading');
      if(loader) loader.style.display = show ? 'flex' : 'none';
    };

    // --- Rendering Logic ---

    const renderDrawer = (cart) => {
      // Update Header/Footer
      countBubble.textContent = cart.item_count;
      countBubble.classList.toggle('hidden', cart.item_count === 0);
      subtotalEl.textContent = formatMoney(cart.total_price);

      if (cart.item_count === 0) {
        renderEmptyState();
        drawerFooter.classList.add('hidden');
      } else {
        renderCartItems(cart.items);
        drawerFooter.classList.remove('hidden');
      }
    };

    const renderCartItems = (items) => {
      let html = `<div class="cart-items-list">`;
      
      items.forEach(item => {
        html += `
          <div class="cart-item">
            <div class="cart-item__img">
              <a href="${item.url}"><img src="${item.image}" alt="${item.title}"></a>
            </div>
            <div class="cart-item__info">
              <div class="cart-item__top">
                <a href="${item.url}" class="cart-item__title">${item.product_title}</a>
                <div class="cart-item__price">${formatMoney(item.final_price)}</div>
              </div>
              ${item.variant_title ? `<div class="cart-item__variant">${item.variant_title}</div>` : ''}
              
              <div class="cart-item__actions">
                <div class="qty-selector">
                  <button class="qty-btn minus" data-key="${item.key}" data-qty="${item.quantity - 1}">âˆ’</button>
                  <input class="qty-input" type="number" value="${item.quantity}" readonly>
                  <button class="qty-btn plus" data-key="${item.key}" data-qty="${item.quantity + 1}">+</button>
                </div>
                <button class="remove-btn" data-key="${item.key}">Remove</button>
              </div>
            </div>
          </div>
        `;
      });
      
      html += `</div>`;
      drawerBody.innerHTML = html;
      attachCartListeners();
    };

    const renderEmptyState = () => {
      let html = `
        <div class="empty-state-container">
          <div class="empty-msg">
            <div class="empty-title">Your cart is empty</div>
            <p>Check out these bestsellers</p>
          </div>
          <div class="rec-grid">
      `;

      recommendations.forEach((product, index) => {
        html += `
          <div class="rec-card" id="rec-${index}">
            <div class="rec-img">
              <img src="${product.image}" alt="${product.title}">
            </div>
            <div class="rec-details">
              <div class="rec-title">${product.title}</div>
              <div class="rec-price">${formatMoney(product.price)}</div>
              
              <div class="rec-actions">
                ${product.has_only_default_variant 
                  ? `<button class="rec-add-btn" onclick="addToCart(${product.variants[0].id})">Add to Cart</button>`
                  : `<button class="rec-add-btn" onclick="showVariants(${index})">Choose Options</button>`
                }
                
                <div class="rec-variants hidden" id="vars-${index}">
                  <select class="rec-select" id="select-${index}">
                    ${product.variants.map(v => 
                      `<option value="${v.id}" ${!v.available ? 'disabled' : ''}>
                        ${v.title} - ${!v.available ? 'Sold Out' : ''}
                      </option>`
                    ).join('')}
                  </select>
                  <button class="rec-confirm-btn" onclick="addToCartFromSelect(${index})">Add</button>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      html += `</div></div>`;
      drawerBody.innerHTML = html;
    };

    // --- Interaction Logic ---

    // 1. Modify Cart
    const updateItem = async (key, qty) => {
      await fetch('/cart/change.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: key, quantity: qty})
      });
      fetchCart();
    };

    // 2. Add to Cart (Global functions for inline HTML)
    window.addToCart = async (id) => {
      toggleLoading(true);
      await fetch('/cart/add.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ items: [{ id: id, quantity: 1 }] })
      });
      fetchCart();
    };

    // 3. Show Variants Dropdown
    window.showVariants = (index) => {
      const btn = document.querySelector(`#rec-${index} .rec-add-btn`);
      const vars = document.getElementById(`vars-${index}`);
      if(btn) btn.style.display = 'none';
      if(vars) vars.classList.remove('hidden');
    };

    // 4. Add from Dropdown
    window.addToCartFromSelect = (index) => {
      const select = document.getElementById(`select-${index}`);
      if(select && select.value) {
        window.addToCart(select.value);
      }
    };

    // Listeners
    const attachCartListeners = () => {
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', () => updateItem(btn.dataset.key, parseInt(btn.dataset.qty)));
      });
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', () => updateItem(btn.dataset.key, 0));
      });
    };

    // Init
    closeBtn.addEventListener('click', closeDrawer);
    drawer.addEventListener('click', (e) => {
      if (e.target === drawer) closeDrawer();
    });

    // Hijack Links
    document.querySelectorAll('a[href="/cart"]').forEach(link => {
      link.addEventListener('click', (e) => { e.preventDefault(); openDrawer(); });
    });
  });
</script>
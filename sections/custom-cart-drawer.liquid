{% comment %}
  Custom Cart Drawer with AJAX & Upsells
  - Replaces standard cart page navigation.
  - Fetches cart data via API.
  - Renders Upsell products from a selected collection.
{% endcomment %}

<div id="custom-cart-drawer" class="cart-drawer" aria-hidden="true">
  
  <!-- Overlay (Background Dimmer) -->
  <div class="cart-drawer__overlay"></div>

  <!-- Main Drawer Container -->
  <div class="cart-drawer__container">
    
    <!-- 1. Header -->
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__title">Your Cart (<span id="drawer-cart-count">0</span>)</h2>
      <button class="cart-drawer__close" aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <!-- 2. Body (Scrollable) -->
    <div class="cart-drawer__body">
      
      <!-- Cart Items Area (Populated by JS) -->
      <div id="cart-drawer-items" class="cart-drawer__items">
        <!-- Items will be injected here via AJAX -->
        <div class="cart-drawer__loading">Loading cart...</div>
      </div>

      <!-- 3. Upsell / Recommendations Section -->
      {% if section.settings.upsell_collection != blank %}
        <div class="cart-drawer__upsell">
          <h3 class="upsell-title">{{ section.settings.upsell_title }}</h3>
          <div class="upsell-grid">
            {% for product in section.settings.upsell_collection.products limit: 4 %}
              <div class="upsell-item">
                <div class="upsell-image">
                  <img src="{{ product.featured_image | image_url: width: 200 }}" alt="{{ product.title }}" loading="lazy">
                </div>
                <div class="upsell-info">
                  <p class="upsell-name">{{ product.title }}</p>
                  <p class="upsell-price">{{ product.price | money }}</p>
                  <button class="upsell-add-btn" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                    Add
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>

    <!-- 4. Footer (Subtotal & Checkout) -->
    <div class="cart-drawer__footer">
      <div class="cart-drawer__subtotal">
        <span>Subtotal</span>
        <span id="drawer-subtotal-price">$0.00</span>
      </div>
      <p class="cart-drawer__note">Tax and shipping calculated at checkout.</p>
      <form action="/cart" method="post">
        <button type="submit" name="checkout" class="cart-drawer__checkout-btn">
          Checkout
        </button>
      </form>
    </div>
  </div>
</div>

<style>
  /* --- 1. Drawer Structure --- */
  .cart-drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999; /* Always on top */
    visibility: hidden;
    transition: visibility 0.3s ease;
  }

  /* Overlay (Dark background) */
  .cart-drawer__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* The Sliding Panel */
  .cart-drawer__container {
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    max-width: 400px; /* Desktop width */
    height: 100%;
    background: #fff;
    transform: translateX(100%); /* Start off-screen right */
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    display: flex;
    flex-direction: column;
  }

  /* --- State: Open --- */
  .cart-drawer.is-open {
    visibility: visible;
  }
  .cart-drawer.is-open .cart-drawer__overlay {
    opacity: 1;
  }
  .cart-drawer.is-open .cart-drawer__container {
    transform: translateX(0); /* Slide in */
  }

  /* --- Header --- */
  .cart-drawer__header {
    padding: 20px;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .cart-drawer__title { margin: 0; font-size: 18px; font-weight: 600; }
  .cart-drawer__close { background: none; border: none; cursor: pointer; padding: 5px; }

  /* --- Body (Scrollable Area) --- */
  .cart-drawer__body {
    flex: 1;
    overflow-y: auto; /* Allows scrolling if many items */
    padding: 20px;
  }

  /* Items */
  .drawer-item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    border-bottom: 1px solid #f5f5f5;
    padding-bottom: 20px;
  }
  .drawer-item__image img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
    background: #f5f5f5;
  }
  .drawer-item__details { flex: 1; }
  .drawer-item__title { margin: 0 0 5px; font-weight: 600; font-size: 14px; }
  .drawer-item__price { font-size: 14px; color: #666; margin-bottom: 10px; }
  
  .drawer-item__controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  /* Quantity Selectors */
  .drawer-qty {
    display: flex;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .drawer-qty__btn {
    background: none; border: none; padding: 5px 10px; cursor: pointer;
  }
  .drawer-qty__input {
    width: 30px; border: none; text-align: center; font-size: 13px; -moz-appearance: textfield;
  }
  .drawer-item__remove {
    background: none; border: none; color: #999; text-decoration: underline; cursor: pointer; font-size: 12px;
  }

  /* --- Upsell Section --- */
  .cart-drawer__upsell {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #f5f5f5;
  }
  .upsell-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; }
  .upsell-item {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
  }
  .upsell-image img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
  .upsell-info { flex: 1; }
  .upsell-name { margin: 0; font-size: 13px; font-weight: 500; }
  .upsell-price { margin: 0 0 5px; font-size: 13px; color: #666; }
  .upsell-add-btn {
    background: #000; color: #fff; border: none; padding: 5px 15px; font-size: 12px; cursor: pointer; border-radius: 4px;
  }

  /* --- Footer --- */
  .cart-drawer__footer {
    padding: 20px;
    border-top: 1px solid #e5e5e5;
    background: #fff;
  }
  .cart-drawer__subtotal {
    display: flex; justify-content: space-between; font-weight: 700; font-size: 18px; margin-bottom: 5px;
  }
  .cart-drawer__note { font-size: 12px; color: #666; margin-bottom: 15px; }
  .cart-drawer__checkout-btn {
    width: 100%; background: #000; color: #fff; border: none; padding: 15px; font-weight: 700; text-transform: uppercase; cursor: pointer;
  }
  .cart-drawer__checkout-btn:hover { opacity: 0.9; }

  /* Empty State */
  .cart-drawer__empty { text-align: center; padding-top: 50px; color: #666; }
</style>



<script>
  document.addEventListener('DOMContentLoaded', () => {
    const drawer = document.getElementById('custom-cart-drawer');
    const overlay = drawer.querySelector('.cart-drawer__overlay');
    const closeBtn = drawer.querySelector('.cart-drawer__close');
    const itemsContainer = document.getElementById('cart-drawer-items');
    const subtotalEl = document.getElementById('drawer-subtotal-price');
    const countEl = document.getElementById('drawer-cart-count');
    
    // 1. Helper: Format Money (Basic version)
    // In production, you might pass Shopify's format string via Liquid
    const formatMoney = (cents) => {
      return '$' + (cents / 100).toFixed(2); 
    };

    // 2. Open/Close Logic
    const openDrawer = () => {
      drawer.classList.add('is-open');
      drawer.setAttribute('aria-hidden', 'false');
      fetchCart(); // Refresh data whenever opened
      sessionStorage.setItem('cartDrawerOpen', 'true');
    };

    const closeDrawer = () => {
      drawer.classList.remove('is-open');
      drawer.setAttribute('aria-hidden', 'true');
      sessionStorage.setItem('cartDrawerOpen', 'false');
    };

    // 3. Fetch Cart Data (AJAX)
    const fetchCart = async () => {
      try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        renderCart(cart);
      } catch (error) {
        console.error('Error fetching cart:', error);
      }
    };

    // 4. Render Cart HTML
    const renderCart = (cart) => {
      // Update Header & Footer
      countEl.textContent = cart.item_count;
      subtotalEl.textContent = formatMoney(cart.total_price);

      // Clear Items Container
      itemsContainer.innerHTML = '';

      if (cart.items.length === 0) {
        itemsContainer.innerHTML = '<p class="cart-drawer__empty">Your cart is empty.</p>';
        return;
      }

      // Loop through items and build HTML string
      cart.items.forEach(item => {
        const itemHTML = `
          <div class="drawer-item">
            <div class="drawer-item__image">
              <a href="${item.url}">
                <img src="${item.image ? item.image : ''}" alt="${item.title}">
              </a>
            </div>
            <div class="drawer-item__details">
              <p class="drawer-item__title"><a href="${item.url}">${item.product_title}</a></p>
              <div class="drawer-item__price">
                ${item.variant_title !== null ? `<small>${item.variant_title}</small><br>` : ''}
                ${formatMoney(item.final_price)}
              </div>
              <div class="drawer-item__controls">
                <div class="drawer-qty">
                  <button class="drawer-qty__btn minus" data-key="${item.key}" data-qty="${item.quantity - 1}">-</button>
                  <input class="drawer-qty__input" type="number" value="${item.quantity}" readonly>
                  <button class="drawer-qty__btn plus" data-key="${item.key}" data-qty="${item.quantity + 1}">+</button>
                </div>
                <button class="drawer-item__remove" data-key="${item.key}" data-qty="0">Remove</button>
              </div>
            </div>
          </div>
        `;
        itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
      });

      // Re-attach event listeners to new buttons
      attachItemListeners();
    };

    // 5. Change Item Quantity (Update Cart)
    const changeItemQty = async (key, newQty) => {
      // Optional: Show loading state
      itemsContainer.style.opacity = '0.5'; 
      
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: key, quantity: newQty })
        });
        const cart = await response.json();
        renderCart(cart); // Re-render with new data
      } catch (error) {
        console.error('Error updating cart:', error);
      } finally {
        itemsContainer.style.opacity = '1';
      }
    };

    // 6. Add Item (Upsell)
    const addItemToCart = async (id, qty = 1) => {
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [{ id: id, quantity: qty }] })
        });
        
        if (response.ok) {
          openDrawer(); // Ensure drawer is open to show success
          fetchCart(); // Refresh drawer
        }
      } catch (error) {
        console.error('Error adding item:', error);
      }
    };

    // 7. Event Listeners
    
    // Helper to attach listeners to dynamic HTML
    const attachItemListeners = () => {
      // Plus/Minus/Remove buttons
      document.querySelectorAll('.drawer-qty__btn, .drawer-item__remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const key = btn.dataset.key;
          const qty = parseInt(btn.dataset.qty);
          changeItemQty(key, qty);
        });
      });
    };

    // Upsell Add Buttons
    document.querySelectorAll('.upsell-add-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const variantId = btn.dataset.variantId;
        btn.textContent = 'Adding...'; // Simple feedback
        addItemToCart(variantId).then(() => {
          btn.textContent = 'Added';
          setTimeout(() => btn.textContent = 'Add', 2000);
        });
      });
    });

    // Close Triggers
    closeBtn.addEventListener('click', closeDrawer);
    overlay.addEventListener('click', closeDrawer);

    // Hijack Cart Icon (The most important part for Dawn theme)
    // Look for standard cart links
    const cartLinks = document.querySelectorAll('a[href="/cart"]');
    cartLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault(); // Stop page reload
        openDrawer();
      });
    });

    // 8. Session Storage Check (On Load)
    if (sessionStorage.getItem('cartDrawerOpen') === 'true') {
      // Optionally re-open drawer if it was open before refresh
      // openDrawer(); 
    }
  });
</script>


{% schema %}
{
  "name": "Custom Cart Drawer",
  "settings": [
    {
      "type": "header",
      "content": "Upsell Settings"
    },
    {
      "type": "text",
      "id": "upsell_title",
      "label": "Upsell Section Title",
      "default": "You may also like"
    },
    {
      "type": "collection",
      "id": "upsell_collection",
      "label": "Upsell Collection"
    }
  ],
  "presets": [
    {
      "name": "Custom Cart Drawer"
    }
  ]
}
{% endschema %}
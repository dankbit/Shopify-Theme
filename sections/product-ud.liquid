

{%- assign product_target = section.settings.featured_product | default: product -%}

<div class="custom-product-section" 
     id="shopify-section-{{ section.id }}"
     data-section-id="{{ section.id }}"
     style="
    --section-padding-top: {{ section.settings.padding_top_mobile }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom_mobile }}px;
    --section-padding-left: {{ section.settings.padding_left_mobile }}px;
    --section-padding-right: {{ section.settings.padding_right_mobile }}px;
  ">
  
  {% style %}
    @media (min-width: 768px) {
      #shopify-section-{{ section.id }} .custom-product-section {
        --section-padding-top: {{ section.settings.padding_top_desktop }}px;
        --section-padding-bottom: {{ section.settings.padding_bottom_desktop }}px;
        --section-padding-left: {{ section.settings.padding_left_desktop }}px;
        --section-padding-right: {{ section.settings.padding_right_desktop }}px;
      }
    }
  {% endstyle %}

  {% if product_target != blank %}
    <div class="product-main-wrapper">
      
      <!-- LEFT COLUMN: Product Media -->
      <div class="product-media-column">
        <div class="product-gallery-container">
          
          <!-- Main Slider Wrapper -->
          <div class="main-slider-wrapper">
            <div class="main-slider-track">
              {% if product_target.media.size > 0 %}
                {% for media in product_target.media %}
                  <div class="slide product-slide" data-media-id="{{ media.id }}">
                    <img src="{{ media | image_url: width: 800 }}" 
                        alt="{{ media.alt | escape }}" 
                        loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                        width="100%" height="100%">
                  </div>
                {% endfor %}
              {% else %}
                <div class="slide product-slide">
                   {{ 'product-1' | placeholder_svg_tag }}
                </div>
              {% endif %}
            </div>

            <!-- Navigation Arrows -->
            <button class="slider-arrow prev-btn" aria-label="Previous image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button class="slider-arrow next-btn" aria-label="Next image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>

            <!-- Slide Counter -->
            <div class="slide-counter">
              <span class="current-slide">1</span> / <span class="total-slides">{{ product_target.media.size | default: 1 }}</span>
            </div>
          </div>

          <!-- Thumbnails -->
          <div class="thumbnails-wrapper">
            {% for media in product_target.media %}
              <button class="thumbnail-btn {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}">
                <img src="{{ media | image_url: width: 150, height: 150, crop: 'center' }}" alt="{{ media.alt }}">
              </button>
            {% endfor %}
          </div>

        </div>
      </div>

      <!-- RIGHT COLUMN: Product Details -->
      <div class="product-info-column">
        {% form 'product', product_target, id: 'product-form-custom', class: 'product-form' %}
          <input type="hidden" name="id" value="{{ product_target.selected_or_first_available_variant.id }}">
          
          {% for block in section.blocks %}
            <div class="product-block block-{{ block.type }}" 
                 {{ block.shopify_attributes }}
                 style="
                   --block-fs-mobile: {{ block.settings.font_size_mobile }}px;
                   --block-fs-desktop: {{ block.settings.font_size_desktop }}px;
                   --block-mt: {{ block.settings.margin_top }}px;
                   --block-mb: {{ block.settings.margin_bottom }}px;
                 "
            >
              
              {% case block.type %}
                
                {% when '@app' %}
                  {% render block %}

                {% when 'title' %}
                  <h1 class="product-title">{{ product_target.title }}</h1>

                {% when 'price' %}
                  <div class="product-price-wrapper" id="price-{{ section.id }}">
                    <span class="price-regular">{{ product_target.selected_or_first_available_variant.price | money }}</span>
                    <s class="price-compare {% unless product_target.selected_or_first_available_variant.compare_at_price > product_target.selected_or_first_available_variant.price %}hidden{% endunless %}">
                      {{ product_target.selected_or_first_available_variant.compare_at_price | money }}
                    </s>
                  </div>
                  <div class="tax-note">Tax included. <a href="#">Shipping</a> calculated at checkout.</div>

                {% when 'variant_picker' %}
                  {% unless product_target.has_only_default_variant %}
                    <div class="variant-picker">
                      {% for option in product_target.options_with_values %}
                        <fieldset class="js-product-option">
                          <legend class="option-label">{{ option.name }}</legend>
                          <div class="option-values">
                            {% for value in option.values %}
                              <input type="radio" 
                                    id="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}"
                                    name="options[{{ option.name | escape }}]"
                                    value="{{ value | escape }}"
                                    {% if option.selected_value == value %}checked{% endif %}
                                    class="visually-hidden variant-radio"
                              >
                              <label for="Option-{{ section.id }}-{{ forloop.parentloop.index0 }}-{{ forloop.index0 }}" class="variant-pill">
                                {{ value }}
                              </label>
                            {% endfor %}
                          </div>
                        </fieldset>
                      {% endfor %}
                    </div>
                  {% endunless %}

                {% when 'quantity_selector' %}
                  <div class="quantity-wrapper">
                    <button type="button" class="qty-btn minus">-</button>
                    <input type="number" name="quantity" value="1" min="1" class="qty-input">
                    <button type="button" class="qty-btn plus">+</button>
                  </div>

                {% when 'buy_buttons' %}
                  <div class="product-actions">
                    <button type="submit" name="add" class="btn-add-to-cart">
                      Add to cart
                    </button>
                    {% if block.settings.show_dynamic_checkout %}
                      {{ form | payment_button }}
                    {% endif %}
                  </div>

                {% when 'description' %}
                  <div class="product-description rte">
                    {{ product_target.description }}
                  </div>

                {% when 'rating' %}
                  <div class="product-rating">
                    <span class="stars">★★★★★</span>
                    <span class="rating-count">5.0 (5)</span>
                  </div>

                {% when 'text' %}
                  <div class="product-text-block" style="color: {{ block.settings.text_color }};">
                    {{ block.settings.text }}
                  </div>

                {% when 'trust_badge' %}
                  <div class="trust-badge-box">
                    <div class="trust-icon">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                    </div>
                    <div class="trust-text">{{ block.settings.text }}</div>
                  </div>

              {% endcase %}
            </div>
          {% endfor %}
        {% endform %}
      </div>
    </div>
  
    <script type="application/json" id="ProductVariants-{{ section.id }}">
      {{ product_target.variants | json }}
    </script>

  {% else %}
    <div style="text-align:center; padding: 50px;">
      <h2>Please select a product</h2>
    </div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Custom Product Main",
  "settings": [
    {
      "type": "product",
      "id": "featured_product",
      "label": "Select Product",
      "info": "If blank, uses the product assigned to the page."
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    { "type": "range", "id": "padding_top_desktop", "min": 0, "max": 100, "step": 10, "unit": "px", "label": "Top (Desktop)", "default": 40 },
    { "type": "range", "id": "padding_bottom_desktop", "min": 0, "max": 100, "step": 10, "unit": "px", "label": "Bottom (Desktop)", "default": 40 },
    { "type": "range", "id": "padding_left_desktop", "min": 0, "max": 100, "step": 10, "unit": "px", "label": "Left (Desktop)", "default": 40 },
    { "type": "range", "id": "padding_right_desktop", "min": 0, "max": 100, "step": 10, "unit": "px", "label": "Right (Desktop)", "default": 40 },
    { "type": "range", "id": "padding_top_mobile", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Top (Mobile)", "default": 20 },
    { "type": "range", "id": "padding_bottom_mobile", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Bottom (Mobile)", "default": 20 },
    { "type": "range", "id": "padding_left_mobile", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Left (Mobile)", "default": 20 },
    { "type": "range", "id": "padding_right_mobile", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Right (Mobile)", "default": 20 }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "Title",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 14, "max": 60, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 32 },
        { "type": "range", "id": "font_size_mobile", "min": 12, "max": 40, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 24 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 10 }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 12, "max": 40, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 24 },
        { "type": "range", "id": "font_size_mobile", "min": 12, "max": 30, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 20 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 10 }
      ]
    },
    {
      "type": "variant_picker",
      "name": "Variant Picker",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 10, "max": 24, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 14 },
        { "type": "range", "id": "font_size_mobile", "min": 10, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 13 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 10 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 20 }
      ]
    },
    {
      "type": "quantity_selector",
      "name": "Quantity Selector",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 12, "max": 24, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 16 },
        { "type": "range", "id": "font_size_mobile", "min": 12, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 16 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 20 }
      ]
    },
    {
      "type": "buy_buttons",
      "name": "Buy Buttons",
      "limit": 1,
      "settings": [
        { "type": "checkbox", "id": "show_dynamic_checkout", "default": true, "label": "Show dynamic checkout buttons" },
        { "type": "range", "id": "font_size_desktop", "min": 12, "max": 24, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 14 },
        { "type": "range", "id": "font_size_mobile", "min": 12, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 14 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 20 }
      ]
    },
    {
      "type": "description",
      "name": "Description",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 12, "max": 24, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 16 },
        { "type": "range", "id": "font_size_mobile", "min": 12, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 15 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 20 }
      ]
    },
    {
      "type": "rating",
      "name": "Rating",
      "limit": 1,
      "settings": [
        { "type": "range", "id": "font_size_desktop", "min": 10, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 14 },
        { "type": "range", "id": "font_size_mobile", "min": 10, "max": 18, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 14 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 10 }
      ]
    },
    {
      "type": "text",
      "name": "Text / Metafield",
      "settings": [
        { "type": "richtext", "id": "text", "default": "<p>Share information about your brand.</p>", "label": "Text" },
        { "type": "color", "id": "text_color", "label": "Text Color", "default": "#000000" },
        { "type": "range", "id": "font_size_desktop", "min": 12, "max": 60, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 16 },
        { "type": "range", "id": "font_size_mobile", "min": 10, "max": 40, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 14 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 0 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 15 }
      ]
    },
    {
      "type": "trust_badge",
      "name": "Trust Badge Box",
      "settings": [
        { "type": "text", "id": "text", "default": "100% Secure Checkout · 30 Days Risk-Free Trial", "label": "Text" },
        { "type": "range", "id": "font_size_desktop", "min": 10, "max": 20, "step": 1, "unit": "px", "label": "Font Size (Desktop)", "default": 13 },
        { "type": "range", "id": "font_size_mobile", "min": 10, "max": 18, "step": 1, "unit": "px", "label": "Font Size (Mobile)", "default": 12 },
        { "type": "range", "id": "margin_top", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Top", "default": 20 },
        { "type": "range", "id": "margin_bottom", "min": 0, "max": 60, "step": 5, "unit": "px", "label": "Margin Bottom", "default": 20 }
      ]
    }
  ],
  "presets": [
    {
      "name": "Custom Product Main"
    }
  ]
}
{% endschema %}

<style>
  /* --- Layout --- */
  .custom-product-section {
    background-color: #ffffff;
    padding: var(--section-padding-top) var(--section-padding-right) var(--section-padding-bottom) var(--section-padding-left);
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-main-wrapper {
    display: flex;
    flex-direction: column;
    gap: 3rem;
  }

  @media (min-width: 1024px) {
    .product-main-wrapper {
      flex-direction: row;
      align-items: flex-start;
    }
    .product-media-column {
      width: 50%;
      position: sticky;
      top: 20px;
      display: flex;
      justify-content: center;
    }
    .product-info-column {
      width: 50%;
      padding-left: 2rem;
    }
  }

  /* --- Global Block Styles --- */
  .product-block {
    margin-top: var(--block-mt);
    margin-bottom: var(--block-mb);
    font-size: var(--block-fs-mobile);
  }

  @media (min-width: 768px) {
    .product-block {
      font-size: var(--block-fs-desktop);
    }
  }

  .product-title, .product-text-block, .product-description {
    font-size: inherit;
    line-height: 1.2;
    margin: 0;
  }
  
  .product-title { margin-bottom: 10px; }
  .product-description { line-height: 1.6; color: #333; }

  /* --- Left Column: Media (Flex Track Slider) --- */
  .product-gallery-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
  }

  .main-slider-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 8px;
    background: #f5f5f5;
    aspect-ratio: 1 / 1;
  }

  .main-slider-track {
    display: flex;
    width: 100%;
    height: 100%;
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
  }

  .product-slide {
    min-width: 100%;
    width: 100%;
    height: 100%;
    flex-shrink: 0;
    position: relative;
  }

  .product-slide img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .product-slide svg {
    width: 100%;
    height: 100%;
    background: #eee;
  }

  .slider-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    background: white;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 5;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }

  .slider-arrow:hover { background: #f0f0f0; transform: translateY(-50%) scale(1.05); }
  .prev-btn { left: 10px; }
  .next-btn { right: 10px; }

  .slide-counter {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #eee;
  }

  .thumbnails-wrapper {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    overflow-x: auto;
    padding-bottom: 5px;
    scrollbar-width: none;
  }
  .thumbnails-wrapper::-webkit-scrollbar { display: none; }

  .thumbnail-btn {
    width: 60px;
    height: 60px;
    border: 2px solid transparent;
    border-radius: 4px;
    padding: 0;
    cursor: pointer;
    flex-shrink: 0;
    overflow: hidden;
    opacity: 0.6;
    transition: all 0.2s;
    background: none;
  }
  .thumbnail-btn img { width: 100%; height: 100%; object-fit: cover; }
  .thumbnail-btn.active { border-color: #000; opacity: 1; }

  /* --- Component Styles --- */
  .product-rating { display: flex; align-items: center; gap: 8px; font-size: inherit; }
  .stars { color: #1a4e38; }

  .product-price-wrapper { font-size: inherit; display: flex; align-items: center; gap: 10px; }
  .price-regular { font-weight: 600; color: #1a4e38; }
  .price-compare { color: #777; text-decoration: line-through; font-size: 0.8em; }
  .price-compare.hidden { display: none; }
  .tax-note { font-size: 12px; color: #666; margin-top: 5px; }

  /* Variant Picker */
  .variant-picker fieldset { border: none; padding: 0; margin: 0 0 15px 0; }
  .option-label { font-weight: 600; margin-bottom: 10px; font-size: inherit; display: block; }
  .option-values { display: flex; flex-wrap: wrap; gap: 10px; }
  .variant-pill {
    border: 1px solid #e5e5e5; padding: 10px 20px; border-radius: 50px;
    cursor: pointer; transition: all 0.2s; font-size: inherit; min-width: 60px;
    text-align: center; color: #333;
  }
  .variant-radio:checked + .variant-pill { border-color: #000; background-color: #fff; color: #000; box-shadow: 0 0 0 1px #000; }
  .visually-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

  /* Quantity Selector */
  .quantity-wrapper {
    display: flex; border: 1px solid #000; width: 140px; height: 48px; border-radius: 4px; overflow: hidden;
  }
  .qty-btn {
    background: none; border: none; width: 40px; font-size: 20px; cursor: pointer; color: #000;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .qty-input {
    flex: 1; min-width: 0; border: none; text-align: center; font-size: inherit;
    appearance: none; -moz-appearance: textfield; padding: 0;
  }
  .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

  /* Buttons */
  .product-actions { display: flex; flex-direction: column; gap: 10px; }
  .btn-add-to-cart {
    width: 100%; padding: 15px; background: #fff; border: 1px solid #000; color: #000;
    font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 4px;
    transition: background 0.2s; font-size: inherit; letter-spacing: 1px;
  }
  .btn-add-to-cart:hover { background: #f5f5f5; }
  .btn-add-to-cart[disabled] {
    background-color: #f0f0f0; color: #999; border-color: #ccc; cursor: not-allowed;
  }
  .shopify-payment-button__button {
    border-radius: 4px !important; font-weight: 700 !important; text-transform: uppercase !important;
    letter-spacing: 1px !important; width: 100%;
  }

  /* Trust Badge */
  .trust-badge-box {
    background-color: #e8f5e9; padding: 15px; border-radius: 4px;
    display: flex; align-items: center; gap: 12px;
  }
  .trust-icon { color: #000; }
  .trust-text { font-size: inherit; font-weight: 500; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = "{{ section.id }}";
  const section = document.querySelector(`#shopify-section-${sectionId}`);
  if (!section.querySelector('.product-main-wrapper')) return;

  // --- 1. CAROUSEL LOGIC ---
  const track = section.querySelector('.main-slider-track');
  const slides = section.querySelectorAll('.product-slide');
  const prevBtn = section.querySelector('.prev-btn');
  const nextBtn = section.querySelector('.next-btn');
  const thumbnails = section.querySelectorAll('.thumbnail-btn');
  const currentSlideEl = section.querySelector('.current-slide');
  
  let counter = 0;
  const totalSlides = slides.length;

  function updateCarousel() {
    track.style.transform = `translateX(-${counter * 100}%)`;
    if(currentSlideEl) currentSlideEl.textContent = counter + 1;
    thumbnails.forEach((thumb, index) => {
      if(index === counter) {
        thumb.classList.add('active');
        thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      } else {
        thumb.classList.remove('active');
      }
    });
  }

  function goNext() {
    counter++;
    if(counter >= totalSlides) counter = 0;
    updateCarousel();
  }

  function goPrev() {
    counter--;
    if(counter < 0) counter = totalSlides - 1;
    updateCarousel();
  }

  if(prevBtn && nextBtn) {
    nextBtn.addEventListener('click', goNext);
    prevBtn.addEventListener('click', goPrev);
  }

  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', function() {
      counter = parseInt(this.dataset.index);
      updateCarousel();
    });
  });

  // --- 2. PRICE & VARIANT & QUANTITY LOGIC ---
  const jsonScript = document.getElementById(`ProductVariants-${sectionId}`);
  const qtyInput = section.querySelector('.qty-input');
  const plusBtn = section.querySelector('.qty-btn.plus');
  const minusBtn = section.querySelector('.qty-btn.minus');
  const priceRegular = section.querySelector('.price-regular');
  const priceCompare = section.querySelector('.price-compare');
  
  let currentUnitPrice = {{ product_target.selected_or_first_available_variant.price }};

  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  function updateTotalPrice() {
    const qty = parseInt(qtyInput.value) || 1;
    const totalPrice = currentUnitPrice * qty;
    if(priceRegular) priceRegular.textContent = formatMoney(totalPrice);
  }

  if(qtyInput && plusBtn && minusBtn) {
    plusBtn.addEventListener('click', () => {
      qtyInput.value = parseInt(qtyInput.value) + 1;
      updateTotalPrice();
    });
    minusBtn.addEventListener('click', () => {
      const val = parseInt(qtyInput.value);
      if(val > 1) {
        qtyInput.value = val - 1;
        updateTotalPrice();
      }
    });
    qtyInput.addEventListener('change', updateTotalPrice);
  }

  if (jsonScript) {
    const productVariants = JSON.parse(jsonScript.textContent);
    const variantRadios = section.querySelectorAll('.variant-radio');
    const hiddenInput = section.querySelector('input[name="id"]');
    const addToCartBtn = section.querySelector('.btn-add-to-cart');

    function getSelectedOptions() {
      const fieldsets = Array.from(section.querySelectorAll('.js-product-option'));
      return fieldsets.map(fieldset => {
        const checkedRadio = fieldset.querySelector('input:checked');
        return checkedRadio ? checkedRadio.value.toString() : null;
      });
    }

    function updateProductInfo() {
      const selectedOptions = getSelectedOptions();
      const currentVariant = productVariants.find(variant => {
        return variant.options.every((optionValue, index) => optionValue.toString() === selectedOptions[index]);
      });

      if (currentVariant) {
        hiddenInput.value = currentVariant.id;
        currentUnitPrice = currentVariant.price;
        updateTotalPrice();

        // Update compare price
        if (currentVariant.compare_at_price > currentVariant.price) {
            if(priceCompare) {
                priceCompare.textContent = formatMoney(currentVariant.compare_at_price);
                priceCompare.classList.remove('hidden');
            }
        } else {
            if(priceCompare) priceCompare.classList.add('hidden');
        }

        // Check if variant is actually available in stock
        if (addToCartBtn) {
          if (currentVariant.available) {
            addToCartBtn.textContent = 'Add to cart';
            addToCartBtn.disabled = false;
            addToCartBtn.removeAttribute('disabled');
            addToCartBtn.classList.remove('disabled');
          } else {
            addToCartBtn.textContent = 'Sold Out';
            addToCartBtn.disabled = true;
            addToCartBtn.setAttribute('disabled', 'disabled');
            addToCartBtn.classList.add('disabled');
          }
        }

        // Update featured media if available
        if (currentVariant.featured_media) {
          const mediaId = currentVariant.featured_media.id;
          const slideIndex = Array.from(slides).findIndex(slide => slide.dataset.mediaId == mediaId);
          if (slideIndex !== -1) {
            counter = slideIndex;
            updateCarousel();
          }
        }

        window.history.replaceState({}, '', `?variant=${currentVariant.id}`);
      } else {
        if (addToCartBtn) {
            addToCartBtn.textContent = 'Unavailable';
            addToCartBtn.disabled = true;
            addToCartBtn.setAttribute('disabled', 'disabled');
        }
      }
    }

    variantRadios.forEach(radio => {
      radio.addEventListener('change', updateProductInfo);
    });

    // Initialize on page load
    updateProductInfo();
  }
});
</script>